---
# code: language=ansible
- name: Redmine verify environment
  hosts: all
  become: true
  gather_facts: true
  pre_tasks:
    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
  roles:
    - role: common
      tags:
        - role_common
    - role: nodejs
      tags:
        - role_nodejs
    - role: mariadb
      tags:
        - role_mariadb
    - role: dehydrated
      tags:
        - role_dehydrated
    - role: nginx
      tags:
        - role_nginx
    - role: mailpit
      tags:
        - role_mailpit
    - role: spamassassin
      tags:
        - role_spamassassin
    - role: tools
      tags:
        - role_tools
    - role: redmine
      tags:
        - role_redmine
    # - role: font
    #   tags:
    #     - role_font
    # - role: webfont
    #   tags:
    #     - role_webfont
  tasks:
    - name: Allow mailpit port
      community.general.ufw:
        rule: allow
        port: 8025
    - name: Install pipx
      ansible.builtin.apt:
        name: pipx
    - name: Generate document files
      environment:
        RAILS_ENV: "{{ redmine_mode }}"
      become: true
      become_user: redmine
      block:
        - name: Check generated API document
          ansible.builtin.stat:
            path: /opt/redmine/doc/app
          register: api_doc_stat_result
        - name: Generate API document
          ansible.builtin.command:
            cmd: bundle exec rake yard
            chdir: /opt/redmine
            creates: /opt/redmine/doc/app
          when: >
            not api_doc_stat_result.stat.exists
            or
            force_update_doc_redmine_api | default(false)
        - name: Create/update Rails ERD config
          ansible.builtin.copy:
            content: "{{ rails_erd_conf | to_nice_yaml }}"
            dest: /opt/redmine/.erdconfig
          register: update_erd_config_result
        - name: Generate ER Diagram
          ansible.builtin.command:
            cmd: bundle exec rake erd
            chdir: /opt/redmine
          when: >
            update_erd_config_result is changed
            or
            force_update_doc_redmine_red | default(false)
    - name: Generate document site
      become: false
      block:
        - name: Install mkdocs-material
          community.general.pipx:
            name: mkdocs-material
            install_deps: true
        - name: Add mkdocs plugins
          community.general.pipx:
            name: mkdocs-material
            state: inject
            inject_packages:
              - mkdocs-git-revision-date-localized-plugin
              - mkdocs-glightbox
              - mkdocs-tooltips
              - mkdocs-section-index
              - mkdocs-literate-nav
              - mkdocs-gen-files
        - name: Update schema files
          ansible.builtin.command:
            cmd: tbls doc -c /vagrant/.tbls.yml -f --rm-dist
            chdir: /vagrant
        - name: Copy Redmine API document
          ansible.posix.synchronize:
            src: /opt/redmine/doc/app/
            dest: /vagrant/docs/api
            delete: true
          become: false
          delegate_to: "{{ inventory_hostname }}"
        - name: Copy Redmine ER diagram
          ansible.builtin.copy:
            src: /opt/redmine/erd.pdf
            dest: /vagrant/docs/erd.pdf
            mode: "0644"
            remote_src: true
        - name: Build doc site
          ansible.builtin.command:
            cmd: ~/.local/bin/mkdocs build
            chdir: /vagrant
  post_tasks:
    - name: Restart services
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        state: restarted
      loop:
        - redmine
        - mariadb
        - nginx
